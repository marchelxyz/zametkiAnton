<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ó–∞–º–µ—Ç–∫–∏ –∏ –ó–∞–¥–∞—á–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f0f0f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            min-height: 100vh;
            padding: 16px;
            padding-bottom: 100px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .add-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s;
        }

        .add-btn:active {
            transform: scale(0.95);
        }

        /* –¢–∞–±—ã */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: var(--tg-theme-hint-color);
            transition: all 0.2s;
        }

        .tab.active {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notes-list, .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .note-card, .task-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .note-card:active, .task-card:active {
            transform: scale(0.98);
        }

        .note-title, .task-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            word-wrap: break-word;
        }

        .note-content, .task-description {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            word-wrap: break-word;
        }

        .note-date, .task-info {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            margin-top: 8px;
        }

        .task-card {
            position: relative;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .task-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .task-status.active {
            background-color: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .task-status.paused {
            background-color: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        .task-interval {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: var(--tg-theme-link-color);
            margin-top: 8px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .task-action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .task-action-btn:active {
            opacity: 0.7;
        }

        .task-action-btn.toggle {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .task-action-btn.delete {
            background-color: #ff3b30;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--tg-theme-hint-color);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--tg-theme-bg-color);
            z-index: 1000;
            padding: 16px;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn-primary {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }

        .btn-danger {
            background-color: #ff3b30;
            color: white;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-hint-color);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color);
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color);
        }

        .interval-group {
            display: flex;
            gap: 8px;
        }

        .interval-group .form-input {
            flex: 1;
        }

        .interval-group .form-select {
            flex: 1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color);
        }

        .delete-zone {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--tg-theme-secondary-bg-color);
        }

        .next-notification {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            margin-top: 4px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–ª–æ–∂–µ–Ω–∏–π */
        .attachments-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--tg-theme-secondary-bg-color);
        }

        .attachments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .attachments-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-hint-color);
        }

        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            font-size: 13px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .upload-btn:active {
            opacity: 0.7;
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }

        .attachment-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--tg-theme-secondary-bg-color);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .attachment-item:active {
            transform: scale(0.95);
        }

        .attachment-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .attachment-item.document {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }

        .attachment-item.document .doc-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .attachment-item.document .doc-name {
            font-size: 10px;
            color: var(--tg-theme-hint-color);
            text-align: center;
            word-break: break-all;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .attachment-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(255, 59, 48, 0.9);
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .attachment-item:hover .attachment-delete,
        .attachment-item:focus-within .attachment-delete {
            opacity: 1;
        }

        /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è */
        @media (hover: none) {
            .attachment-delete {
                opacity: 1;
            }
        }

        .note-attachments-preview {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .note-attachments-preview .preview-thumb {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .note-attachments-preview .preview-count {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background-color: var(--tg-theme-secondary-bg-color);
            font-size: 11px;
            color: var(--tg-theme-hint-color);
            flex-shrink: 0;
        }

        .hidden-file-input {
            display: none;
        }

        .upload-progress {
            margin-top: 8px;
            padding: 8px;
            border-radius: 8px;
            background-color: var(--tg-theme-secondary-bg-color);
            font-size: 13px;
            color: var(--tg-theme-hint-color);
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .image-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .image-viewer.active {
            display: flex;
        }

        .image-viewer img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .image-viewer-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1 id="page-title">üìù –ó–∞–º–µ—Ç–∫–∏</h1>
            <button class="add-btn" onclick="openNewItem()">+</button>
        </div>

        <!-- –¢–∞–±—ã -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>
            <button class="tab" onclick="switchTab('tasks')">‚è∞ –ó–∞–¥–∞—á–∏</button>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–º–µ—Ç–æ–∫ -->
        <div id="notes-tab" class="tab-content active">
            <div id="notes-loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="notes-container" class="notes-list" style="display: none;"></div>
            <div id="notes-empty" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-text">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫.<br>–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é!</div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–¥–∞—á -->
        <div id="tasks-tab" class="tab-content">
            <div id="tasks-loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="tasks-container" class="tasks-list" style="display: none;"></div>
            <div id="tasks-empty" class="empty-state" style="display: none;">
                <div class="empty-state-icon">‚è∞</div>
                <div class="empty-state-text">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.<br>–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ -->
    <div id="note-modal" class="modal">
        <div class="modal-header">
            <span class="modal-title" id="note-modal-title">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</span>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeNoteModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" id="note-title-input" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫...">
        </div>

        <div class="form-group">
            <label class="form-label">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</label>
            <textarea id="note-content-input" class="form-input form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..."></textarea>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –≤–ª–æ–∂–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–º–µ—Ç–æ–∫) -->
        <div id="attachments-section" class="attachments-section" style="display: none;">
            <div class="attachments-header">
                <span class="attachments-title">üìé –í–ª–æ–∂–µ–Ω–∏—è</span>
                <button class="upload-btn" onclick="triggerFileUpload()" id="upload-btn">
                    üì∑ –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
            <input type="file" id="file-input" class="hidden-file-input" 
                   accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar"
                   multiple onchange="handleFileSelect(event)">
            <div id="upload-progress" class="upload-progress">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="attachments-grid" class="attachments-grid"></div>
        </div>

        <div id="note-delete-zone" class="delete-zone" style="display: none;">
            <button class="btn btn-danger" onclick="deleteCurrentNote()">üóë –£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
        </div>
    </div>

    <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <div id="image-viewer" class="image-viewer" onclick="closeImageViewer()">
        <button class="image-viewer-close" onclick="closeImageViewer()">‚úï</button>
        <img id="viewer-image" src="" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–¥–∞—á -->
    <div id="task-modal" class="modal">
        <div class="modal-header">
            <span class="modal-title" id="task-modal-title">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</span>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTaskModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
            <input type="text" id="task-title-input" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í—ã–ø–∏—Ç—å –≤–æ–¥—ã">
        </div>

        <div class="form-group">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <textarea id="task-description-input" class="form-input form-textarea" placeholder="–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏..."></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</label>
            <div class="interval-group">
                <input type="number" id="interval-value" class="form-input" value="1" min="1" max="999">
                <select id="interval-unit" class="form-select">
                    <option value="minutes">–ú–∏–Ω—É—Ç</option>
                    <option value="hours" selected>–ß–∞—Å–æ–≤</option>
                    <option value="days">–î–Ω–µ–π</option>
                </select>
            </div>
        </div>

        <div id="task-delete-zone" class="delete-zone" style="display: none;">
            <button class="btn btn-danger" onclick="deleteCurrentTask()">üóë –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        if (tg.themeParams) {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#2481cc');
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f0f0f0');
        }

        let notes = [];
        let tasks = [];
        let currentNoteId = null;
        let currentTaskId = null;
        let currentTab = 'notes';
        let isInTelegram = false;
        let isWebMode = false;  // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ Telegram
        let currentAttachments = [];
        let cachedInitData = null;  // –ö–µ—à–∏—Ä—É–µ–º initData –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏
        let sessionToken = null;    // –¢–æ–∫–µ–Ω —Å–µ—Å—Å–∏–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
        let webAccessToken = null;  // –¢–æ–∫–µ–Ω –¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏ (–±–µ–∑ Telegram)
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ localStorage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        try {
            sessionToken = localStorage.getItem('session_token');
            if (sessionToken) {
                console.log('[AUTH] –ó–∞–≥—Ä—É–∂–µ–Ω session_token –∏–∑ localStorage');
            }
            
            webAccessToken = localStorage.getItem('web_access_token');
            if (webAccessToken) {
                console.log('[AUTH] –ó–∞–≥—Ä—É–∂–µ–Ω web_access_token –∏–∑ localStorage');
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é initData
            const storedInitData = localStorage.getItem('cached_init_data');
            if (storedInitData) {
                cachedInitData = storedInitData;
                console.log('[AUTH] –ó–∞–≥—Ä—É–∂–µ–Ω–∞ cached initData –∏–∑ localStorage, –¥–ª–∏–Ω–∞:', cachedInitData.length);
            }
        } catch (e) {
            console.warn('[AUTH] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage:', e);
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å initData –≤ localStorage –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        function saveInitDataToStorage(initData) {
            if (!initData) return;
            cachedInitData = initData;
            try {
                localStorage.setItem('cached_init_data', initData);
                console.log('[AUTH] initData —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage');
            } catch (e) {
                console.warn('[AUTH] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å initData –≤ localStorage:', e);
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å web access token
        function saveWebAccessToken(token) {
            webAccessToken = token;
            try {
                localStorage.setItem('web_access_token', token);
                console.log('[AUTH] web_access_token —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage');
            } catch (e) {
                console.warn('[AUTH] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å web_access_token:', e);
            }
        }
        
        // –û—á–∏—Å—Ç–∏—Ç—å web access token
        function clearWebAccessToken() {
            webAccessToken = null;
            try {
                localStorage.removeItem('web_access_token');
            } catch (e) {}
        }
        
        // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞)
        function clearAllAuthData() {
            sessionToken = null;
            cachedInitData = null;
            webAccessToken = null;
            isWebMode = false;
            try {
                localStorage.removeItem('session_token');
                localStorage.removeItem('cached_init_data');
                localStorage.removeItem('web_access_token');
                console.log('[AUTH] –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—á–∏—â–µ–Ω—ã');
            } catch (e) {}
        }
        
        // –ü–æ–ª—É—á–∞–µ–º initData –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (fallback)
        function extractInitData() {
            // 1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: tg.initData –æ—Ç SDK (—Å–∞–º–∞—è —Å–≤–µ–∂–∞—è)
            if (tg.initData && tg.initData.length > 0) {
                console.log('[TG] initData –ø–æ–ª—É—á–µ–Ω–∞ –æ—Ç SDK, –¥–ª–∏–Ω–∞:', tg.initData.length);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤–µ–∂—É—é initData
                saveInitDataToStorage(tg.initData);
                return tg.initData;
            }
            
            // 2. Fallback: –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL hash (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥–∞—é—Ç —Ç–∞–∫)
            if (window.location.hash && window.location.hash.length > 1) {
                const hashData = window.location.hash.substring(1);
                if (hashData.includes('tgWebAppData=')) {
                    try {
                        const params = new URLSearchParams(hashData);
                        const webAppData = params.get('tgWebAppData');
                        if (webAppData) {
                            const decoded = decodeURIComponent(webAppData);
                            console.log('[TG] initData –ø–æ–ª—É—á–µ–Ω–∞ –∏–∑ URL hash, –¥–ª–∏–Ω–∞:', decoded.length);
                            saveInitDataToStorage(decoded);
                            return decoded;
                        }
                    } catch (e) {
                        console.warn('[TG] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ hash:', e);
                    }
                }
            }
            
            // 3. Fallback: –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('tgWebAppData')) {
                const webAppData = urlParams.get('tgWebAppData');
                if (webAppData) {
                    console.log('[TG] initData –ø–æ–ª—É—á–µ–Ω–∞ –∏–∑ URL params, –¥–ª–∏–Ω–∞:', webAppData.length);
                    saveInitDataToStorage(webAppData);
                    return webAppData;
                }
            }
            
            // 4. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –µ—Å–ª–∏ –µ—Å—Ç—å
            if (cachedInitData) {
                console.log('[TG] –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é initData –∏–∑ localStorage, –¥–ª–∏–Ω–∞:', cachedInitData.length);
                return cachedInitData;
            }
            
            console.warn('[TG] initData –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ');
            return '';
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram
        function checkTelegramEnvironment() {
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å initData –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–≤–∫–ª—é—á–∞—è localStorage)
            const initData = extractInitData();
            const hasInitData = initData && initData.length > 0;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ session_token (–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –±–µ–∑ —Å–≤–µ–∂–µ–π initData)
            const hasSession = !!sessionToken;
            
            console.log('[TG] initData length:', initData ? initData.length : 0);
            console.log('[TG] session_token:', hasSession ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');
            console.log('[TG] initDataUnsafe.user:', tg.initDataUnsafe ? JSON.stringify(tg.initDataUnsafe.user) : 'null');
            console.log('[TG] platform:', tg.platform);
            console.log('[TG] version:', tg.version);
            
            // –ú–æ–∂–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∏–±–æ initData, –ª–∏–±–æ session_token
            if (hasInitData || hasSession) {
                isInTelegram = true;
                if (hasInitData) {
                    console.log('[TG] initData –¥–æ—Å—Ç—É–ø–Ω–∞, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞');
                } else {
                    console.log('[TG] –†–∞–±–æ—Ç–∞–µ–º —Å session_token –∏–∑ localStorage');
                }
            } else if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                // initDataUnsafe –µ—Å—Ç—å, –Ω–æ initData –ø—É—Å—Ç–∞—è - —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞
                // –¢–∞–∫–æ–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö (—Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏, —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
                isInTelegram = false;
                console.warn('[TG] –í–ù–ò–ú–ê–ù–ò–ï: initDataUnsafe –¥–æ—Å—Ç—É–ø–Ω–∞, –Ω–æ initData –ø—É—Å—Ç–∞—è!');
                console.warn('[TG] –≠—Ç–æ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –≤–µ—Ä—Å–∏–µ–π Telegram –∏–ª–∏ WebApp SDK');
            } else {
                isInTelegram = false;
                console.warn('[TG] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram. initData –∏ session –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.');
            }
            
            return isInTelegram;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram
        function showNotInTelegramWarning() {
            const notesLoading = document.getElementById('notes-loading');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ initDataUnsafe (—á–∞—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
            const hasPartialData = !!(tg.initDataUnsafe && tg.initDataUnsafe.user);
            const hasAnyInitData = !!(tg.initData || cachedInitData);
            
            let warningHtml;
            
            if (hasPartialData || hasAnyInitData) {
                // initDataUnsafe –µ—Å—Ç—å, –Ω–æ initData –ø—É—Å—Ç–∞—è - –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π
                warningHtml = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üîÑ</div>
                        <div style="font-size: 16px; color: var(--tg-theme-text-color); margin-bottom: 12px;">
                            <b>–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</b>
                        </div>
                        <div style="font-size: 14px; color: var(--tg-theme-hint-color); margin-bottom: 16px;">
                            –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.<br><br>
                            –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:<br>
                            1. –ó–∞–∫—Ä—ã—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ<br>
                            2. –ù–∞–∂–∞—Ç—å "–°–±—Ä–æ—Å–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å"<br>
                            3. –û–±–Ω–æ–≤–∏—Ç—å Telegram –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
                        </div>
                        <button class="btn btn-primary" onclick="forceReload()" style="margin-bottom: 8px; width: 100%;">
                            üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                        <button class="btn btn-secondary" onclick="resetAndReload()" style="margin-bottom: 8px; width: 100%;">
                            üóë –°–±—Ä–æ—Å–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                        <button class="btn btn-secondary" onclick="enterWebMode()" style="width: 100%;">
                            üåê –í–æ–π—Ç–∏ –≤ –≤–µ–±-–≤–µ—Ä—Å–∏—é
                        </button>
                        <div style="font-size: 11px; color: var(--tg-theme-hint-color); margin-top: 12px;">
                            Telegram v${tg.version || '?'} ‚Ä¢ ${tg.platform || 'unknown'}
                        </div>
                    </div>
                `;
            } else {
                // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–µ–±-–≤–µ—Ä—Å–∏—é
                warningHtml = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üåê</div>
                        <div style="font-size: 16px; color: var(--tg-theme-text-color); margin-bottom: 12px;">
                            <b>–ó–∞–º–µ—Ç–∫–∏ –∏ –ó–∞–¥–∞—á–∏</b>
                        </div>
                        <div style="font-size: 14px; color: var(--tg-theme-hint-color); margin-bottom: 20px;">
                            –í—ã –æ—Ç–∫—Ä—ã–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.<br><br>
                            –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:
                        </div>
                        <button class="btn btn-primary" onclick="enterWebMode()" style="margin-bottom: 12px; width: 100%;">
                            üåê –í–æ–π—Ç–∏ –≤ –≤–µ–±-–≤–µ—Ä—Å–∏—é
                        </button>
                        <div style="font-size: 12px; color: var(--tg-theme-hint-color); margin-bottom: 20px;">
                            –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ<br>–æ—Ç Telegram-–∞–∫–∫–∞—É–Ω—Ç–∞
                        </div>
                        <div style="border-top: 1px solid var(--tg-theme-secondary-bg-color); padding-top: 16px; margin-top: 8px;">
                            <div style="font-size: 13px; color: var(--tg-theme-hint-color); margin-bottom: 8px;">
                                –ò–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram:
                            </div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">
                                –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ<br>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–µ–Ω—é
                            </div>
                        </div>
                    </div>
                `;
            }
            
            notesLoading.innerHTML = warningHtml;
        }
        
        // –í–æ–π—Ç–∏ –≤ –≤–µ–±-—Ä–µ–∂–∏–º
        async function enterWebMode() {
            const notesLoading = document.getElementById('notes-loading');
            notesLoading.innerHTML = '<div style="text-align: center; padding: 40px;">üîÑ –í—Ö–æ–¥ –≤ –≤–µ–±-–≤–µ—Ä—Å–∏—é...</div>';
            
            try {
                const success = await createWebAuthSession();
                if (success) {
                    isWebMode = true;
                    console.log('[WEB] –í—Ö–æ–¥ –≤ –≤–µ–±-—Ä–µ–∂–∏–º —É—Å–ø–µ—à–µ–Ω');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤–µ–±-—Ä–µ–∂–∏–º
                    document.getElementById('page-title').innerHTML = 'üìù –ó–∞–º–µ—Ç–∫–∏ <span style="font-size: 12px; opacity: 0.7;">(–≤–µ–±)</span>';
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    await loadNotes();
                } else {
                    showWebModeError('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –≤–µ–±-–≤–µ—Ä—Å–∏—é');
                }
            } catch (error) {
                console.error('[WEB] –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –≤–µ–±-—Ä–µ–∂–∏–º:', error);
                showWebModeError(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤–µ–±-—Ä–µ–∂–∏–º–∞
        function showWebModeError(message) {
            const notesLoading = document.getElementById('notes-loading');
            notesLoading.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                    <div style="font-size: 16px; color: var(--tg-theme-text-color); margin-bottom: 12px;">
                        <b>–û—à–∏–±–∫–∞</b>
                    </div>
                    <div style="font-size: 14px; color: var(--tg-theme-hint-color); margin-bottom: 16px;">
                        ${escapeHtml(message)}
                    </div>
                    <button class="btn btn-primary" onclick="enterWebMode()" style="margin-bottom: 8px; width: 100%;">
                        üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                    <button class="btn btn-secondary" onclick="showNotInTelegramWarning()" style="width: 100%;">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                </div>
            `;
        }
        
        // –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
        function resetAndReload() {
            clearAllAuthData();
            window.location.reload(true);
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function forceReload() {
            // –û—á–∏—â–∞–µ–º –∫–µ—à –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
            cachedInitData = null;
            window.location.reload(true);
        }
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ initData
        function tryLoadAnyway() {
            document.getElementById('notes-loading').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            tryLoadWithoutVerification();
        }

        // –ü–æ–ª—É—á–∞–µ–º initData –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function getInitData() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é extractInitData –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            const initData = extractInitData();
            
            if (!initData) {
                console.warn('[TG] getInitData: initData –ø—É—Å—Ç–∞—è');
                console.warn('[TG] tg.platform:', tg.platform);
                console.warn('[TG] tg.version:', tg.version);
                console.warn('[TG] window.Telegram:', typeof window.Telegram);
            } else {
                console.log('[TG] getInitData: initData –ø–æ–ª—É—á–µ–Ω–∞, –¥–ª–∏–Ω–∞:', initData.length);
            }
            
            return initData;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function showMessage(message, type = 'info') {
            console.log('[MSG]', type, message);
            try {
                if (type === 'error') {
                    if (tg && tg.showAlert) {
                        tg.showAlert(message);
                    } else {
                        alert(message);
                    }
                } else {
                    if (tg && tg.showAlert) {
                        tg.showAlert(message);
                    } else {
                        alert(message);
                    }
                }
            } catch (e) {
                console.error('[MSG] –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                alert(message);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å session_token –≤ localStorage
        function saveSessionToken(token) {
            sessionToken = token;
            try {
                localStorage.setItem('session_token', token);
                console.log('[AUTH] Session token —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage');
            } catch (e) {
                console.warn('[AUTH] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å session_token –≤ localStorage:', e);
            }
        }
        
        // –û—á–∏—Å—Ç–∏—Ç—å session_token
        function clearSessionToken() {
            sessionToken = null;
            try {
                localStorage.removeItem('session_token');
            } catch (e) {}
        }
        
        // –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
        async function createAuthSession() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º extractInitData —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–≤–∫–ª—é—á–∞—è localStorage)
            const initData = extractInitData();
            
            if (!initData) {
                console.warn('[AUTH] –ù–µ—Ç initData –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏');
                return false;
            }
            
            try {
                console.log('[AUTH] –°–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, initData –¥–ª–∏–Ω–∞:', initData.length);
                
                const response = await fetch('/api/auth/session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': initData
                    }
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    console.error('[AUTH] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞:', e);
                    return false;
                }
                
                if (response.ok && result.session_token) {
                    saveSessionToken(result.session_token);
                    console.log('[AUTH] ‚úì –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ –¥–ª—è user:', result.user?.id);
                    return true;
                } else {
                    console.error('[AUTH] ‚úó –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é:', result.error || result.message);
                    // –ï—Å–ª–∏ initData –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ - –æ—á–∏—â–∞–µ–º –∫–µ—à
                    if (response.status === 401) {
                        console.log('[AUTH] initData –Ω–µ–≤–∞–ª–∏–¥–Ω–∞, –æ—á–∏—â–∞–µ–º –∫–µ—à...');
                        try {
                            localStorage.removeItem('cached_init_data');
                            cachedInitData = null;
                        } catch (e) {}
                    }
                    return false;
                }
            } catch (error) {
                console.error('[AUTH] ‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
                return false;
            }
        }
        
        // –°–æ–∑–¥–∞—Ç—å –≤–µ–±-—Å–µ—Å—Å–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ Telegram)
        async function createWebAuthSession(userName = null) {
            try {
                console.log('[AUTH] –°–æ–∑–¥–∞—ë–º –≤–µ–±-—Å–µ—Å—Å–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                
                const body = {};
                if (userName) {
                    body.name = userName;
                }
                
                const response = await fetch('/api/auth/web', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    console.error('[AUTH] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞:', e);
                    return false;
                }
                
                if (response.ok && result.access_token) {
                    saveWebAccessToken(result.access_token);
                    isWebMode = true;
                    console.log('[AUTH] ‚úì –í–µ–±-—Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ, user:', result.user?.id, result.is_new ? '(–Ω–æ–≤—ã–π)' : '(—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)');
                    return true;
                } else {
                    console.error('[AUTH] ‚úó –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–µ–±-—Å–µ—Å—Å–∏—é:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('[AUTH] ‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–±-—Å–µ—Å—Å–∏–∏:', error);
                return false;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤–µ–±-—Ç–æ–∫–µ–Ω–∞
        async function checkWebAccessToken() {
            if (!webAccessToken) return false;
            
            try {
                const response = await fetch('/api/auth/web/check', {
                    method: 'GET',
                    headers: {
                        'X-Web-Access-Token': webAccessToken
                    }
                });
                
                const result = await response.json();
                return result.valid === true;
            } catch (e) {
                console.error('[AUTH] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ–±-—Ç–æ–∫–µ–Ω–∞:', e);
                return false;
            }
        }
        
        // API –≤—ã–∑–æ–≤—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function apiCall(method, endpoint, data = null, retryAfterReauth = true) {
            const initData = getInitData();
            
            // –°–æ–∑–¥–∞—ë–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –º–µ—Ç–æ–¥–∞–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: Web Access Token (–¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏)
            if (webAccessToken) {
                headers['X-Web-Access-Token'] = webAccessToken;
            }
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Session Token (Telegram)
            if (sessionToken) {
                headers['X-Session-Token'] = sessionToken;
            }
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Telegram initData
            if (initData) {
                headers['X-Telegram-Init-Data'] = initData;
            }
            
            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!initData && !sessionToken && !webAccessToken) {
                console.warn('[API] –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }
            
            const options = {
                method: method,
                headers: headers
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            console.log('[API]', method, endpoint, 
                        'initData:', initData ? initData.length + 'b' : '–Ω–µ—Ç', 
                        'session:', sessionToken ? '–µ—Å—Ç—å' : '–Ω–µ—Ç',
                        'web:', webAccessToken ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');
            
            let response;
            let result;
            
            try {
                response = await fetch(endpoint, options);
            } catch (networkError) {
                console.error('[API] –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:', networkError);
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            }
            
            try {
                result = await response.json();
            } catch (parseError) {
                console.error('[API] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', parseError);
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å HTTP-–æ—Ç–≤–µ—Ç–∞
            if (!response.ok) {
                let errorMessage = result.error || `HTTP –æ—à–∏–±–∫–∞: ${response.status}`;
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                if (response.status === 401) {
                    console.error('[API] –û—à–∏–±–∫–∞ 401 (Unauthorized)');
                    
                    // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞
                    if (retryAfterReauth) {
                        console.log('[API] –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è...');
                        
                        // –ï—Å–ª–∏ –≤ –≤–µ–±-—Ä–µ–∂–∏–º–µ - –ø—Ä–æ–±—É–µ–º –≤–µ–±-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                        if (isWebMode) {
                            console.log('[API] –í–µ–±-—Ä–µ–∂–∏–º: –ø—Ä–æ–±—É–µ–º –≤–µ–±-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
                            clearWebAccessToken();
                            const webAuthSuccess = await createWebAuthSession();
                            if (webAuthSuccess) {
                                console.log('[API] –í–µ–±-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å...');
                                return apiCall(method, endpoint, data, false);
                            }
                        } else {
                            // Telegram —Ä–µ–∂–∏–º
                            clearSessionToken();
                            
                            const freshInitData = extractInitData();
                            
                            if (freshInitData) {
                                console.log('[API] –ï—Å—Ç—å initData, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é...');
                                const reauthSuccess = await createAuthSession();
                                if (reauthSuccess) {
                                    console.log('[API] –ü–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å...');
                                    return apiCall(method, endpoint, data, false);
                                } else {
                                    console.error('[API] –ü–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å');
                                    clearAllAuthData();
                                }
                            } else {
                                console.error('[API] –ù–µ—Ç initData –¥–ª—è –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                                clearAllAuthData();
                            }
                        }
                    }
                    
                    if (isWebMode) {
                        errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                    } else {
                        errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–∫—Ä–æ–π—Ç–µ –∏ –∑–∞–Ω–æ–≤–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
                    }
                }
                
                throw new Error(errorMessage);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞
            if (result.error) {
                throw new Error(result.error);
            }
            
            return result;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        function switchTab(tab) {
            currentTab = tab;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const webSuffix = isWebMode ? ' <span style="font-size: 12px; opacity: 0.7;">(–≤–µ–±)</span>' : '';
            
            if (tab === 'notes') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('notes-tab').classList.add('active');
                document.getElementById('page-title').innerHTML = 'üìù –ó–∞–º–µ—Ç–∫–∏' + webSuffix;
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('tasks-tab').classList.add('active');
                document.getElementById('page-title').innerHTML = '‚è∞ –ó–∞–¥–∞—á–∏' + webSuffix;
                loadTasks();
            }
        }

        // –û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∞–±–∞
        function openNewItem() {
            if (currentTab === 'notes') {
                openNewNote();
            } else {
                openNewTask();
            }
        }

        // ==================== –ó–ê–ú–ï–¢–ö–ò ====================

        async function loadNotes() {
            try {
                document.getElementById('notes-loading').style.display = 'block';
                document.getElementById('notes-loading').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                document.getElementById('notes-container').style.display = 'none';
                document.getElementById('notes-empty').style.display = 'none';
                
                const result = await apiCall('GET', '/api/notes');
                notes = result.notes || [];
                renderNotes();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                
                const loadingEl = document.getElementById('notes-loading');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤—è–∑–∞–Ω–∞ –ª–∏ –æ—à–∏–±–∫–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
                if (error.message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü') || error.message.includes('401') || error.message.includes('Unauthorized')) {
                    const initDataLen = getInitData().length;
                    loadingEl.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üîê</div>
                            <div style="font-size: 14px; color: var(--tg-theme-hint-color); margin-bottom: 16px;">
                                –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.<br><br>
                                –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:<br>
                                1. –ó–∞–∫—Ä—ã—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ<br>
                                2. –û–±–Ω–æ–≤–∏—Ç—å Telegram –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
                            </div>
                            <button class="btn btn-primary" onclick="forceReload()" style="margin-bottom: 8px; width: 100%;">
                                üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                            </button>
                            <button class="btn btn-secondary" onclick="retryInit()" style="width: 100%;">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                            </button>
                            <div style="font-size: 10px; color: var(--tg-theme-hint-color); margin-top: 12px;">
                                initData: ${initDataLen} –±–∞–π—Ç ‚Ä¢ v${tg.version || '?'} ‚Ä¢ ${tg.platform || '?'}
                            </div>
                        </div>
                    `;
                } else {
                    loadingEl.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 32px; margin-bottom: 12px;">‚ö†Ô∏è</div>
                            <div style="font-size: 14px; color: var(--tg-theme-hint-color); margin-bottom: 16px;">
                                ${escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}
                            </div>
                            <button class="btn btn-primary" onclick="loadNotes()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                        </div>
                    `;
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        function retryInit() {
            initAttempts = 0;
            document.getElementById('notes-loading').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            initApp();
        }

        function renderNotes() {
            const container = document.getElementById('notes-container');
            const emptyState = document.getElementById('notes-empty');
            const loading = document.getElementById('notes-loading');

            loading.style.display = 'none';

            if (notes.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'flex';

            container.innerHTML = notes.map(note => {
                const attachments = note.attachments || [];
                const hasAttachments = attachments.length > 0;
                const imageAttachments = attachments.filter(a => a.file_type === 'image');
                
                let attachmentsPreview = '';
                if (hasAttachments) {
                    attachmentsPreview = '<div class="note-attachments-preview">';
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ 3 –ø—Ä–µ–≤—å—é
                    const previewCount = Math.min(imageAttachments.length, 3);
                    for (let i = 0; i < previewCount; i++) {
                        attachmentsPreview += `<img class="preview-thumb" src="/api/attachments/${imageAttachments[i].id}" alt="">`;
                    }
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å –µ—â—ë —Ñ–∞–π–ª—ã
                    if (attachments.length > 3) {
                        attachmentsPreview += `<span class="preview-count">+${attachments.length - 3}</span>`;
                    } else if (attachments.length > imageAttachments.length) {
                        const docCount = attachments.length - imageAttachments.length;
                        attachmentsPreview += `<span class="preview-count">üìÑ${docCount}</span>`;
                    }
                    attachmentsPreview += '</div>';
                }
                
                return `
                    <div class="note-card" onclick="openNote(${note.id})">
                        <div class="note-title">${escapeHtml(note.title)}</div>
                        <div class="note-content">${escapeHtml(note.content || '–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ')}</div>
                        ${attachmentsPreview}
                        <div class="note-date">${formatDate(note.updated_at || note.created_at)}</div>
                    </div>
                `;
            }).join('');
        }

        function openNewNote() {
            currentNoteId = null;
            currentAttachments = [];
            document.getElementById('note-modal-title').textContent = '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞';
            document.getElementById('note-title-input').value = '';
            document.getElementById('note-content-input').value = '';
            document.getElementById('note-delete-zone').style.display = 'none';
            document.getElementById('attachments-section').style.display = 'none';
            document.getElementById('note-modal').classList.add('active');
            tg.BackButton.show();
            tg.BackButton.onClick(closeNoteModal);
        }

        function openNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;

            currentNoteId = noteId;
            currentAttachments = note.attachments || [];
            document.getElementById('note-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
            document.getElementById('note-title-input').value = note.title;
            document.getElementById('note-content-input').value = note.content || '';
            document.getElementById('note-delete-zone').style.display = 'block';
            document.getElementById('attachments-section').style.display = 'block';
            renderAttachments();
            document.getElementById('note-modal').classList.add('active');
            tg.BackButton.show();
            tg.BackButton.onClick(closeNoteModal);
        }

        function renderAttachments() {
            const grid = document.getElementById('attachments-grid');
            
            if (currentAttachments.length === 0) {
                grid.innerHTML = '<div style="font-size: 13px; color: var(--tg-theme-hint-color); text-align: center; padding: 12px;">–ù–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å" —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã.</div>';
                return;
            }
            
            grid.innerHTML = currentAttachments.map(att => {
                if (att.file_type === 'image') {
                    return `
                        <div class="attachment-item" onclick="viewImage(${att.id})">
                            <img src="/api/attachments/${att.id}" alt="${escapeHtml(att.filename)}">
                            <button class="attachment-delete" onclick="deleteAttachment(${att.id}, event)">‚úï</button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="attachment-item document" onclick="downloadAttachment(${att.id}, '${escapeHtml(att.filename)}')">
                            <span class="doc-icon">${getDocIcon(att.filename)}</span>
                            <span class="doc-name">${escapeHtml(att.filename)}</span>
                            <button class="attachment-delete" onclick="deleteAttachment(${att.id}, event)">‚úï</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function getDocIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return 'üìï';
                case 'doc':
                case 'docx': return 'üìò';
                case 'xls':
                case 'xlsx': return 'üìó';
                case 'txt': return 'üìÑ';
                case 'zip':
                case 'rar': return 'üóúÔ∏è';
                default: return 'üìé';
            }
        }

        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            if (!currentNoteId) {
                showMessage('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É', 'error');
                return;
            }
            
            const progressEl = document.getElementById('upload-progress');
            const uploadBtn = document.getElementById('upload-btn');
            
            uploadBtn.disabled = true;
            progressEl.classList.add('active');
            
            let successCount = 0;
            let errorCount = 0;
            let lastError = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                progressEl.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${i + 1} –∏–∑ ${files.length}...`;
                
                try {
                    const result = await uploadFile(file);
                    if (result && result.id) {
                        currentAttachments.push(result);
                        successCount++;
                    } else {
                        errorCount++;
                        lastError = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    errorCount++;
                    lastError = error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }
            }
            
            uploadBtn.disabled = false;
            progressEl.classList.remove('active');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ –∂–µ —Ñ–∞–π–ª—ã –µ—â—ë —Ä–∞–∑
            event.target.value = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            renderAttachments();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–º–µ—Ç–∫—É –≤ —Å–ø–∏—Å–∫–µ
            const noteIndex = notes.findIndex(n => n.id === currentNoteId);
            if (noteIndex !== -1) {
                notes[noteIndex].attachments = currentAttachments;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (errorCount > 0) {
                showMessage(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${successCount}, –æ—à–∏–±–æ–∫: ${errorCount}. ${lastError}`, 'error');
            } else if (successCount > 0) {
                try {
                    tg.HapticFeedback.notificationOccurred('success');
                } catch(e) {}
            }
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const initData = getInitData();
            
            // –°–æ–∑–¥–∞—ë–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –º–µ—Ç–æ–¥–∞–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const headers = {};
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: Web Access Token
            if (webAccessToken) {
                headers['X-Web-Access-Token'] = webAccessToken;
            }
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Session Token
            if (sessionToken) {
                headers['X-Session-Token'] = sessionToken;
            }
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Telegram initData
            if (initData) {
                headers['X-Telegram-Init-Data'] = initData;
            }
            
            if (!initData && !sessionToken && !webAccessToken) {
                throw new Error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }
            
            let response;
            try {
                response = await fetch(`/api/notes/${currentNoteId}/attachments`, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
            } catch (networkError) {
                console.error('[UPLOAD] –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:', networkError);
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
            
            let result;
            try {
                result = await response.json();
            } catch (parseError) {
                console.error('[UPLOAD] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', parseError);
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }
            
            if (!response.ok) {
                console.error('[UPLOAD] –û—à–∏–±–∫–∞ HTTP:', response.status, result);
                throw new Error(result.error || `–û—à–∏–±–∫–∞: ${response.status}`);
            }
            
            return result;
        }

        function viewImage(attachmentId) {
            const viewer = document.getElementById('image-viewer');
            const img = document.getElementById('viewer-image');
            img.src = `/api/attachments/${attachmentId}`;
            viewer.classList.add('active');
        }

        function closeImageViewer() {
            const viewer = document.getElementById('image-viewer');
            viewer.classList.remove('active');
        }

        function downloadAttachment(attachmentId, filename) {
            const link = document.createElement('a');
            link.href = `/api/attachments/${attachmentId}`;
            link.download = filename;
            link.click();
        }

        async function deleteAttachment(attachmentId, event) {
            event.stopPropagation();
            
            const doDelete = async () => {
                try {
                    const initData = getInitData();
                    
                    // –°–æ–∑–¥–∞—ë–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –º–µ—Ç–æ–¥–∞–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    const headers = {};
                    
                    if (webAccessToken) {
                        headers['X-Web-Access-Token'] = webAccessToken;
                    }
                    if (sessionToken) {
                        headers['X-Session-Token'] = sessionToken;
                    }
                    if (initData) {
                        headers['X-Telegram-Init-Data'] = initData;
                    }
                    
                    const response = await fetch(`/api/attachments/${attachmentId}`, {
                        method: 'DELETE',
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        const result = await response.json().catch(() => ({}));
                        throw new Error(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                    
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
                    currentAttachments = currentAttachments.filter(a => a.id !== attachmentId);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–º–µ—Ç–∫—É –≤ —Å–ø–∏—Å–∫–µ
                    const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                    if (noteIndex !== -1) {
                        notes[noteIndex].attachments = currentAttachments;
                    }
                    
                    renderAttachments();
                    try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                    showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–ª–æ–∂–µ–Ω–∏—è: ' + (error.message || ''), 'error');
                }
            };

            try {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –≤–ª–æ–∂–µ–Ω–∏–µ?', async (confirmed) => {
                    if (confirmed) await doDelete();
                });
            } catch(e) {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –≤–ª–æ–∂–µ–Ω–∏–µ?')) {
                    await doDelete();
                }
            }
        }

        function closeNoteModal() {
            document.getElementById('note-modal').classList.remove('active');
            tg.BackButton.hide();
            tg.BackButton.offClick(closeNoteModal);
        }

        async function saveNote() {
            const title = document.getElementById('note-title-input').value.trim();
            const content = document.getElementById('note-content-input').value.trim();

            if (!title) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏', 'error');
                return;
            }

            console.log('[SAVE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏:', { title: title.substring(0, 30), isNew: !currentNoteId });

            try {
                let result;
                if (currentNoteId) {
                    result = await apiCall('PUT', `/api/notes/${currentNoteId}`, { title, content });
                } else {
                    result = await apiCall('POST', '/api/notes', { title, content });
                }

                console.log('[SAVE] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–º–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (–µ—Å—Ç—å id –≤ –æ—Ç–≤–µ—Ç–µ)
                if (result && result.id) {
                    console.log('[SAVE] ‚úì –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, id:', result.id);
                    closeNoteModal();
                    await loadNotes();
                    try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                } else {
                    console.error('[SAVE] ‚úó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç:', result);
                    throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª ID –∑–∞–º–µ—Ç–∫–∏');
                }
            } catch (error) {
                console.error('[SAVE] ‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                
                let errorMsg = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                if (errorMsg.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü') || errorMsg.includes('401')) {
                    errorMsg = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ó–∞–∫—Ä–æ–π—Ç–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ.';
                }
                showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + errorMsg, 'error');
            }
        }

        async function deleteCurrentNote() {
            if (!currentNoteId) return;

            const doDelete = async () => {
                try {
                    const result = await apiCall('DELETE', `/api/notes/${currentNoteId}`);
                    if (result && result.success) {
                        closeNoteModal();
                        await loadNotes();
                        try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                    showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            };

            try {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?', async (confirmed) => {
                    if (confirmed) await doDelete();
                });
            } catch(e) {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) {
                    await doDelete();
                }
            }
        }

        // ==================== –ó–ê–î–ê–ß–ò ====================

        async function loadTasks() {
            try {
                document.getElementById('tasks-loading').style.display = 'block';
                document.getElementById('tasks-loading').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                document.getElementById('tasks-container').style.display = 'none';
                document.getElementById('tasks-empty').style.display = 'none';
                
                const result = await apiCall('GET', '/api/tasks?active_only=false');
                tasks = result.tasks || [];
                renderTasks();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
                
                const loadingEl = document.getElementById('tasks-loading');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤—è–∑–∞–Ω–∞ –ª–∏ –æ—à–∏–±–∫–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
                if (error.message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü') || error.message.includes('401') || error.message.includes('Unauthorized')) {
                    const initDataLen = getInitData().length;
                    loadingEl.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üîê</div>
                            <div style="font-size: 14px; color: var(--tg-theme-hint-color); margin-bottom: 16px;">
                                –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.<br><br>
                                –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:<br>
                                1. –ó–∞–∫—Ä—ã—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ<br>
                                2. –û–±–Ω–æ–≤–∏—Ç—å Telegram –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
                            </div>
                            <button class="btn btn-primary" onclick="forceReload()" style="margin-bottom: 8px; width: 100%;">
                                üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                            </button>
                            <button class="btn btn-secondary" onclick="retryInit()" style="width: 100%;">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                            </button>
                            <div style="font-size: 10px; color: var(--tg-theme-hint-color); margin-top: 12px;">
                                initData: ${initDataLen} –±–∞–π—Ç ‚Ä¢ v${tg.version || '?'} ‚Ä¢ ${tg.platform || '?'}
                            </div>
                        </div>
                    `;
                } else {
                    loadingEl.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 32px; margin-bottom: 12px;">‚ö†Ô∏è</div>
                            <div style="font-size: 14px; color: var(--tg-theme-hint-color); margin-bottom: 16px;">
                                ${escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}
                            </div>
                            <button class="btn btn-primary" onclick="loadTasks()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                        </div>
                    `;
                }
            }
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            const emptyState = document.getElementById('tasks-empty');
            const loading = document.getElementById('tasks-loading');

            loading.style.display = 'none';

            if (tasks.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'flex';

            container.innerHTML = tasks.map(task => `
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-title">${escapeHtml(task.title)}</div>
                        <span class="task-status ${task.is_active ? 'active' : 'paused'}">
                            ${task.is_active ? 'üîî –ê–∫—Ç–∏–≤–Ω–∞' : '‚è∏ –ü–∞—É–∑–∞'}
                        </span>
                    </div>
                    ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                    <div class="task-interval">‚è∞ –ö–∞–∂–¥—ã–µ ${formatInterval(task.interval_minutes)}</div>
                    ${task.is_active && task.next_notification ? `
                        <div class="next-notification">–°–ª–µ–¥—É—é—â–µ–µ: ${formatDate(task.next_notification)}</div>
                    ` : ''}
                    <div class="task-actions">
                        <button class="task-action-btn toggle" onclick="toggleTask(${task.id}, event)">
                            ${task.is_active ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å'}
                        </button>
                        <button class="task-action-btn delete" onclick="deleteTask(${task.id}, event)">
                            üóë –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openNewTask() {
            currentTaskId = null;
            document.getElementById('task-modal-title').textContent = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-description-input').value = '';
            document.getElementById('interval-value').value = '1';
            document.getElementById('interval-unit').value = 'hours';
            document.getElementById('task-delete-zone').style.display = 'none';
            document.getElementById('task-modal').classList.add('active');
            tg.BackButton.show();
            tg.BackButton.onClick(closeTaskModal);
        }

        function openTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            currentTaskId = taskId;
            document.getElementById('task-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
            document.getElementById('task-title-input').value = task.title;
            document.getElementById('task-description-input').value = task.description || '';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–¥–∏–Ω–∏—Ü—É –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
            let value, unit;
            if (task.interval_minutes >= 1440 && task.interval_minutes % 1440 === 0) {
                value = task.interval_minutes / 1440;
                unit = 'days';
            } else if (task.interval_minutes >= 60 && task.interval_minutes % 60 === 0) {
                value = task.interval_minutes / 60;
                unit = 'hours';
            } else {
                value = task.interval_minutes;
                unit = 'minutes';
            }
            
            document.getElementById('interval-value').value = value;
            document.getElementById('interval-unit').value = unit;
            document.getElementById('task-delete-zone').style.display = 'block';
            document.getElementById('task-modal').classList.add('active');
            tg.BackButton.show();
            tg.BackButton.onClick(closeTaskModal);
        }

        function closeTaskModal() {
            document.getElementById('task-modal').classList.remove('active');
            tg.BackButton.hide();
            tg.BackButton.offClick(closeTaskModal);
        }

        function getIntervalMinutes() {
            const value = parseInt(document.getElementById('interval-value').value) || 1;
            const unit = document.getElementById('interval-unit').value;
            
            switch (unit) {
                case 'minutes': return value;
                case 'hours': return value * 60;
                case 'days': return value * 1440;
                default: return value;
            }
        }

        async function saveTask() {
            const title = document.getElementById('task-title-input').value.trim();
            const description = document.getElementById('task-description-input').value.trim();
            const interval_minutes = getIntervalMinutes();

            if (!title) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏', 'error');
                return;
            }

            console.log('[SAVE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏:', { title: title.substring(0, 30), isNew: !currentTaskId, interval_minutes });

            try {
                let result;
                if (currentTaskId) {
                    result = await apiCall('PUT', `/api/tasks/${currentTaskId}`, { 
                        title, 
                        description, 
                        interval_minutes 
                    });
                } else {
                    result = await apiCall('POST', '/api/tasks', { 
                        title, 
                        description, 
                        interval_minutes 
                    });
                }

                console.log('[SAVE] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (–µ—Å—Ç—å id –≤ –æ—Ç–≤–µ—Ç–µ)
                if (result && result.id) {
                    console.log('[SAVE] ‚úì –ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, id:', result.id);
                    closeTaskModal();
                    await loadTasks();
                    try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                } else {
                    console.error('[SAVE] ‚úó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç:', result);
                    throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª ID –∑–∞–¥–∞—á–∏');
                }
            } catch (error) {
                console.error('[SAVE] ‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                
                let errorMsg = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                if (errorMsg.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü') || errorMsg.includes('401')) {
                    errorMsg = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ó–∞–∫—Ä–æ–π—Ç–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ.';
                }
                showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + errorMsg, 'error');
            }
        }

        async function toggleTask(taskId, event) {
            event.stopPropagation();
            try {
                const result = await apiCall('POST', `/api/tasks/${taskId}/toggle`);
                if (result && result.id) {
                    await loadTasks();
                    try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}
                } else {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:', error);
                try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                showMessage('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        }

        async function deleteTask(taskId, event) {
            event.stopPropagation();
            
            const doDelete = async () => {
                try {
                    const result = await apiCall('DELETE', `/api/tasks/${taskId}`);
                    if (result && result.success) {
                        await loadTasks();
                        try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                    showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            };

            try {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É –∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?', async (confirmed) => {
                    if (confirmed) await doDelete();
                });
            } catch(e) {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É –∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?')) {
                    await doDelete();
                }
            }
        }

        async function deleteCurrentTask() {
            if (!currentTaskId) return;

            const doDelete = async () => {
                try {
                    const result = await apiCall('DELETE', `/api/tasks/${currentTaskId}`);
                    if (result && result.success) {
                        closeTaskModal();
                        await loadTasks();
                        try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                    showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            };

            try {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?', async (confirmed) => {
                    if (confirmed) await doDelete();
                });
            } catch(e) {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
                    await doDelete();
                }
            }
        }

        // ==================== –£–¢–ò–õ–ò–¢–´ ====================

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            // –î–∞—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ —É–∂–µ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
            const date = new Date(dateString + '+03:00');
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'Europe/Moscow'
            });
        }

        function formatInterval(minutes) {
            if (minutes < 60) {
                return `${minutes} –º–∏–Ω.`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const remainingMins = minutes % 60;
                if (remainingMins === 0) {
                    return `${hours} —á.`;
                }
                return `${hours} —á. ${remainingMins} –º–∏–Ω.`;
            } else {
                const days = Math.floor(minutes / 1440);
                const remainingHours = Math.floor((minutes % 1440) / 60);
                if (remainingHours === 0) {
                    return `${days} –¥–Ω.`;
                }
                return `${days} –¥–Ω. ${remainingHours} —á.`;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
        let initAttempts = 0;
        const MAX_INIT_ATTEMPTS = 3;  // –£–º–µ–Ω—å—à–µ–Ω–æ - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±—ã—Å—Ç—Ä–æ–π
        const INIT_DELAY_MS = 200;    // –£–º–µ–Ω—å—à–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞
        
        async function initApp() {
            initAttempts++;
            console.log(`[INIT] –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ${initAttempts}/${MAX_INIT_ATTEMPTS}`);
            console.log(`[INIT] session_token: ${sessionToken ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}`);
            console.log(`[INIT] web_access_token: ${webAccessToken ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}`);
            console.log(`[INIT] cached_init_data: ${cachedInitData ? cachedInitData.length + 'b' : '–Ω–µ—Ç'}`);
            console.log(`[INIT] tg.initDataUnsafe.user:`, tg.initDataUnsafe?.user ? JSON.stringify(tg.initDataUnsafe.user) : '–Ω–µ—Ç');
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –í–µ–±-—Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ –±—ã–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Ä–∞–Ω–µ–µ)
            if (webAccessToken) {
                console.log('[INIT] –ï—Å—Ç—å web_access_token, –ø—Ä–æ–≤–µ—Ä—è–µ–º...');
                const webTokenValid = await checkWebAccessToken();
                if (webTokenValid) {
                    console.log('[INIT] –í–µ–±-—Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –≤—Ö–æ–¥–∏–º –≤ –≤–µ–±-—Ä–µ–∂–∏–º');
                    isWebMode = true;
                    document.getElementById('page-title').innerHTML = 'üìù –ó–∞–º–µ—Ç–∫–∏ <span style="font-size: 12px; opacity: 0.7;">(–≤–µ–±)</span>';
                    await loadNotes();
                    return;
                } else {
                    console.log('[INIT] –í–µ–±-—Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –æ—á–∏—â–∞–µ–º...');
                    clearWebAccessToken();
                }
            }
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Session token (Telegram) - –µ—Å–ª–∏ –µ—Å—Ç—å, —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (sessionToken) {
                console.log('[INIT] –ï—Å—Ç—å session_token, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');
                try {
                    await loadNotes();
                    return;
                } catch (error) {
                    console.warn('[INIT] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å session_token, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è...');
                    clearSessionToken();
                }
            }
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram initData
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ initData (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è) –∏–ª–∏ initDataUnsafe (–Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ä–∞–∑—É)
            const initData = extractInitData();
            const hasInitData = initData && initData.length > 0;
            const hasUnsafeUser = tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id;
            
            if (hasInitData) {
                console.log('[INIT] ‚úì –ù–∞–π–¥–µ–Ω–∞ initData, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
                const sessionCreated = await createAuthSession();
                if (sessionCreated) {
                    console.log('[INIT] ‚úì –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
                }
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
                try {
                    await loadNotes();
                    return;
                } catch (error) {
                    console.error('[INIT] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑
                    if (error.message && (error.message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü') || error.message.includes('401'))) {
                        clearSessionToken();
                        if (initAttempts < MAX_INIT_ATTEMPTS) {
                            setTimeout(initApp, INIT_DELAY_MS);
                            return;
                        }
                    }
                }
            } else if (hasUnsafeUser && initAttempts < MAX_INIT_ATTEMPTS) {
                // initDataUnsafe –¥–æ—Å—Ç—É–ø–Ω–∞, –Ω–æ initData –µ—â—ë –Ω–µ—Ç - –∂–¥—ë–º –Ω–µ–º–Ω–æ–≥–æ
                console.log(`[INIT] initDataUnsafe.user –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ initData –µ—â—ë –Ω–µ—Ç. –ñ–¥—ë–º... (–ø–æ–ø—ã—Ç–∫–∞ ${initAttempts}/${MAX_INIT_ATTEMPTS})`);
                setTimeout(initApp, INIT_DELAY_MS);
                return;
            }
            
            // –ï—Å–ª–∏ initData –µ—â—ë –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø–æ–ø—ã—Ç–∫–∏ - –ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑
            if (initAttempts < MAX_INIT_ATTEMPTS) {
                console.log(`[INIT] initData –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ ${INIT_DELAY_MS}ms...`);
                setTimeout(initApp, INIT_DELAY_MS);
                return;
            }
            
            // –ò—Å—á–µ—Ä–ø–∞–Ω—ã –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤—Ö–æ–¥–∞ (Telegram –∏–ª–∏ –≤–µ–±)
            console.warn('[INIT] –ù–∏ –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä...');
            showNotInTelegramWarning();
        }
        
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞–∂–µ –±–µ–∑ initData (–¥–ª—è —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        async function tryLoadWithoutVerification() {
            try {
                console.log('[INIT] –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏...');
                const result = await apiCall('GET', '/api/notes');
                
                // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ–º
                if (result && result.notes !== undefined) {
                    console.log('[INIT] –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ');
                    notes = result.notes || [];
                    renderNotes();
                    return;
                }
            } catch (error) {
                console.error('[INIT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏:', error.message);
            }
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤—Ö–æ–¥–∞ (–≤–µ–± –∏–ª–∏ Telegram)
            showNotInTelegramWarning();
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Telegram SDK
        setTimeout(initApp, 150);
    </script>
</body>
</html>
